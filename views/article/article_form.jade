extends ../layout

block content
    script(src="https://cdn.ckeditor.com/4.9.1/standard/ckeditor.js")
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.2/css/bootstrap-select.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.2/js/bootstrap-select.min.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <!-- Include Editor style. -->
    <link href='https://cdn.jsdelivr.net/npm/froala-editor@2.9.1/css/froala_editor.min.css' rel='stylesheet' type='text/css' />
    <link href='https://cdn.jsdelivr.net/npm/froala-editor@2.9.1/css/froala_style.min.css' rel='stylesheet' type='text/css' />
     
    <!-- Include JS file. -->
    <script type='text/javascript' src='https://cdn.jsdelivr.net/npm/froala-editor@2.9.1/js/froala_editor.min.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/npm/froala-editor@2.9.1/js/froala_editor.min.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/npm/froala-editor@2.9.1/js/plugins/video.min.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/npm/froala-editor@2.9.1/js/plugins/image.min.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/npm/froala-editor@2.9.1/js/plugins/link.min.js'></script>


    h1 Create article

    form.white-round-div(method='POST' action='')
        div.form-group
            label(for='article_url') URL de l'article:
            input#article_url.form-control(type='text' name='article_url' required='true' )
            button.btn.btn-outline-dark(type="button" onclick='return getMetaData()') Fill fields

        div.form-group
            label(for='site_name') Nom du site:
            input#site_name.form-control(type='text' placeholder='Nom du site' name='site_name' required='true')

        div.form-group
            label(for='type') Type de contenu:
            input#type.form-control(type='text' placeholder='Type de contenu' name='type' required='true' )

        div.form-group
            label(for='title') Titre:
            input#title.form-control(type='text' placeholder='Titre' name='title' required='true')

        div.form-group
            label(for='published_time') Date de publication:
            input#published_time.form-control(type='date' placeholder='Date de publication' name='published_time' required='true')

        div.form-group
            label(for='description') Description:
            textarea#description.sd-textarea.form-control(name='description' placeholder='Courte description' required='true' rows='3')

        label(for='image') Image URL:
        input#image.form-control(type='text' name='image' placeholder='Image d\'illustration' required='true' )

        label(for='content') Contenu de l'article:
        textarea(name='content')

        button.btn.btn-primary(type='submit') Envoyer

        each error in errors
            .text-danger error

    script.

        $(function() { $('textarea[name=content]').froalaEditor({
            heightMin: 600,
            language: 'fr',
            imageUploadRemoteUrls: false, // keep image URL instead of uploading to server
            videoUpload: false
        }) });
        const hidden_btns = ['#strikeThrough-1', '#superscript-1', '#subscript-1', '#imageUpload-1'];
        $(document).ready(() => {
            hidden_btns.map(id => $(id).css('display', 'none'));
        })
        
        function getMetaData() {
            const article_url = $("input[name=article_url]").val();
            console.log(article_url)
            fetch('meta', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin',
                body: JSON.stringify({url: article_url})  
            }).then(response => response.json())
                .then(results => fillFromMeta(results))
                .catch(err => console.log(err));
        }
        var m = {}
        function fillFromMeta(meta) {
            m = meta
            console.log(meta)
            meta['published_time'] = meta['published_time'] != undefined ? meta['published_time'].split('T')[0] : {};
            for (key in meta) {
                $(`[name=${key}]`).val(meta[key])
            }
            if (meta['type'].indexOf('video')>-1) {
                const video_url = embedYouTubeUrl($('input[name=article_url]').val());
                $('textarea[name=content]').froalaEditor('video.insert', 
                            `<iframe src="${video_url}"
                                    allowfullscreen=""
                                    class="fr-draggable"
                                    width="640" height="360"
                                    frameborder="0"></iframe>`);
            }
            function embedYouTubeUrl(url) {
                let video_id = url.split('&')[0];
                video_id = video_id.split('watch?v=')[1];
                return 'https://www.youtube.com/embed/' + video_id
            }
        }
